<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Danny</title>
    <!-- <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bulma@0.9.1/css/bulma.min.css"> -->
    <link rel="stylesheet" type="text/css" href="./css/bulma.min.css">
    <link rel="stylesheet" type="text/css" href="./css/calendar.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.2/css/all.min.css">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <script>
      $(document).ready(function() {
        $(".navbar-burger").click(function() {
            $(".navbar-burger").toggleClass("is-active");
            $(".navbar-menu").toggleClass("is-active");
        });
      });
    </script>
    <script src="https://accounts.google.com/gsi/client" onload="initClient()" async defer></script>
    <script src="./js/colors.js"></script>
    <script>
      var client;
      var access_token;

      var EventType = {
        0:"nothing",
        1:"work",
        2:"programming",
        3:"holiday",
        4:"other"
      }

      // Calendar
      var Settings = new Object();
      Settings.startAtJan = false; //whether to start calendar at today or january


      var eventPool = new Object();

      function initClient(){
        client = google.accounts.oauth2.initTokenClient({
          client_id: '616265016561-of2t07oji032h5al2nuu1ehu4ms8ic8m.apps.googleusercontent.com',
          scope: 'https://www.googleapis.com/auth/calendar.events.readonly \
          https://www.googleapis.com/auth/calendar.readonly',
          callback: (tokenResponse)=>{
            access_token = tokenResponse.access_token;
          }
        })
      }

      function getToken(){
        client.requestAccessToken();
      }

      function revokeToken(){
        google.accounts.oauth2.revoke(access_token, ()=>{console.log('access token revoked')});
      }

      function utc(datetime){
        return Date.UTC(datetime.getFullYear(), datetime.getMonth(), datetime.getDate());
      }

      function checkForEvent(datetime){
        // const EventType = {
        //   0:"nothing",
        //   1:"work",
        //   2:"programming",
        //   3:"holiday"
        //   4:"other"
        // }

        let datestr = datetime.getDate() + "-" + (datetime.getMonth()+1) + "-" + datetime.getFullYear();
        if(datestr in eventPool){
          // console.log("found event: " + eventPool[datestr]);
          return eventPool[datestr];
        }
        
        // return [EventType[2], 3];
        // if(datetime.getDay()===0){
        //   return [EventType[0], 0];
        // }// no work on sundays
        return [EventType[0], 0];
      }

      function loadCalendar() {
        function gatherEvents(xmlObject){

          let eventSummaries = new Array(11);
          for(let i=0;i<11;i++){
            eventSummaries[i] = [];
          }

          for(const [i, event] of Object.entries(xmlObject.items)){

            if(event.end === undefined){
              console.log("EVENT: " + JSON.stringify(event, null, 2));
              console.log(i + " skipped: " + event);
              continue;
            } 



            // let current_time = new Date();
            let timestamp_end = utc(new Date(event.end.dateTime));
            // Object.keys(event).forEach((prop)=> console.log(prop + ":" + event[prop]));
            // Object.keys(event.end).forEach((prop)=> console.log(prop + ":" + event.end[prop]));
            if(isNaN(timestamp_end)){
              console.log("EVENT: " + JSON.stringify(event, null, 2));
              console.log(i + " skipped: " + event + " DT:" + event.end.dateTime);
              continue;
            }
            // if(timestamp_end < utc(current_time)) continue;

            // console.log("EVENT3: " + JSON.stringify(event, null, 2));

            let timestamp_start = utc(new Date(event.start.dateTime));

            // check if event summary contains word "work" or "vakantie"
            let event_summary = event.summary.toLowerCase();
            let category = EventType[4];
            if(event_summary.includes("vakantie")) category = EventType[3];
            if(event_summary.includes("werk")) category = EventType[1];
            // console.log("event type: " + category + ". found: " + event_summary);
            let color_id = 1;
            if(event.colorId){
              // console.log("Color: " + event.colorId + "=" + Colors.eventById[event.colorId]);
              color_id = event.colorId;
            }
            eventSummaries[color_id].push(event_summary);

            // add an event for every day of multi day events.
            const msday = 1000*60*60*24;
            
            for(let d = timestamp_start; d <= timestamp_end; d += msday){
              let event_dt = new Date(d);
              let str = event_dt.getDate() + "-" + (event_dt.getMonth()+1) + "-" + event_dt.getFullYear();
              console.log(str + ":" + category);
              eventPool[str] = [category, color_id];
            }
          }

          //summary histogram by color
          console.log("eventSummaries lengths: ");
          for(let ctr = 0; ctr < 11; ctr++){
            console.log(ctr + "colorId" + eventSummaries[ctr].length);
          }

          // start to construct legend
          let usedColors = [];
          for(let i=0;i<11;i++){
            if(eventSummaries[i].length>0){
              usedColors.push(i);
            }
          }
          let descriptors = new Array(11);

          // console.log("usedColors: " + usedColors.toString());

          //find most common word to describe used colours
          class DefaultDict {
            constructor(defaultVal) {
              return new Proxy({}, {
                get: (target, name) => name in target ? target[name] : defaultVal
              })
            }
          }

          let colDescriptors = new Object(11);
          for(let colorId=0; colorId<usedColors.length;colorId++){
            let bagOfWords = new DefaultDict(0);

            //accumulate and count all words for this color
            for(let summary of eventSummaries[usedColors[colorId]]){
              for(let word of summary.split(" ")){
                bagOfWords[word] += 1;
              }
            }

            // console.log("bagofwords for color " + usedColors[colorId] +"="+ Colors.eventById[usedColors[colorId]] + " :" + JSON.stringify(bagOfWords, null, 2));

            // descriptor is most common word. 
            const colDescriptor = Object.entries(bagOfWords).reduce((a, b) => a[1] > b[1] ? a : b)[0];
            colDescriptors[usedColors[colorId]] = colDescriptor;
          }
          // console.log("colDescriptors:" + JSON.stringify(colDescriptors, null, 2));

          function drawLegend(descriptionByColorId){
            let legendList = ""
            for(let colorId=0; colorId<11; colorId++){
              let descriptor = descriptionByColorId[colorId];
              if(descriptor===null || descriptor ===undefined) continue;

              legendList += "<li><span class='legend_item' style='background-color: " + Colors.eventById[colorId] + ";'></span>" + descriptor + "</li>"
            }
            console.log(legendList);

            document.getElementById("legendList").innerHTML = legendList;
          }

          drawLegend(colDescriptors);

        }

        // var xhr1 = new XMLHttpRequest();
        // xhr1.open('GET', 'https://www.googleapis.com/calendar/v3/colors');
        // xhr1.setRequestHeader('Authorization', 'Bearer ' + access_token);
        // xhr1.send();
        // xhr1.onload = function(){
        //   let returnedColors = JSON.parse(xhr1.response);
        //   // for(const [i, color] of Object.entries(returnedColors.event)){
        //   //   console.log("COLORS: " + i + ":" + color.background);
        //   // }
        //   console.log(JSON.stringify(returnedColors.event, null, 2));
        // };

        var xhr = new XMLHttpRequest();
        //store dates into iso format for use in api call
        let timeMin = new Date();
        if(Settings.startAtJan){
          timeMin = (new Date(new Date().getFullYear(), 0, 1));
        }
        let timeMax = (new Date(timeMin.getFullYear()+1, timeMin.getMonth(), timeMin.getDate()));
        let callstring = "https://www.googleapis.com/calendar/v3/calendars/primary/events?timeMin=" + timeMin.toISOString() + "&timeMax=" + timeMax.toISOString() + "&maxResults=1500&singleEvents=True";
        console.log("Callstring: " + callstring);
        
        // xhr.open('GET', 'https://www.googleapis.com/calendar/v3/calendars/primary/events?timeMin=2023-11-05T00:00:00Z&timeMax=2024-11-05T00:00:00Z&maxResults=1500&singleEvents=True');//&timeMin=2023-11-06T00:00:00+01:00
        xhr.open('GET', callstring);//&timeMin=2023-11-06T00:00:00+01:00
        xhr.setRequestHeader('Authorization', 'Bearer ' + access_token);
        // timestamp for 17:40 CET 6-11-2023 is 2023-11-06T17:40:00+01:00
        xhr.send();
        xhr.onload = function() {
          // console.log(`Loaded: ${xhr.status} ${xhr.response}`);
          let returnedEvents = JSON.parse(xhr.response);
          gatherEvents(returnedEvents);
          drawCalendar();
        };
      }
      
    </script>
    
  </head>
  <body>
    <nav class="navbar is-dark" role="navigation" aria-label="main navigation">
      <div class="navbar-brand">
        <div role="button" class="navbar-burger" aria-label="menu" aria-expanded="false" data-target="yourstandardnavbar">
          <span aria-hidden="true"></span>
          <span aria-hidden="true"></span>
          <span aria-hidden="true"></span>
        </div>
      </div>

      <div id="yourstandardnavbar" class="navbar-menu">
        <div class="navbar-start">
          <a class="navbar-item tablinks" onclick="openTab(event, 'about')">
            <span>About</span>
          </a>

          <a class="navbar-item" href="./resume.pdf">
            Resume
          </a>

          <a class="navbar-item" href="https://github.com/drogaar">
            <span class="icon">
                <i class="fab fa-github"></i>
            </span>
            <span>Github</span>
          </a>

          <a class="navbar-item tablinks" onclick="openTab(event, 'calendar')">
            <span>Planning</span>
          </a>
        </div>

        <div class="navbar-end">
          <a class="navbar-item calendar-google-ctrl" onclick="getToken()" style="display:none;">
            <span>Authorise your google</span>
          </a>
          <a class="navbar-item calendar-google-ctrl" onclick="loadCalendar()" style="display:none;">
            <span>Load calendar</span>
          </a>
          <a class="navbar-item calendar-google-ctrl" onclick="revokeToken()" style="display:none;">
            <span>Revoke google</span>
          </a>
        </div>
      </div>
    </nav>

    <!-- Header -->
    <section class="hero is-dark is-small">
      <div class="hero-body">
        <div class="container">
          <h1 class="title is-1" id="title">
            Danny Rogaar
          </h1>
        </div>
      </div>
    </section>

    <!-- About -->
    <section class="section tabSection" id="about" style="display:none;">
      <div class="section-heading">
        <div class="container">
          <h3 class="title is-2">About</h3>
          <p>
            I am a master student <strong>AI</strong> currently looking for work and a place to improve. I have experience with neural networks, machine learning and have personally enjoyed scientific visualisations. Amongst other skills and languages, I have become good at python while working on these topics. <br>For more info, feel free to checkout my <a href="./resume.pdf">resume</a>!
          </p>
        </div>
      </div>
    </section>

    <section class="section tabSection" id = "calendar" style="display:none;">
      <div class="section-heading">
        <div class="container" id="calendar_heading">
          <div class="tile is-ancestor is-parent">
            <div class="tile is-parent">

              <div class="tile is-4 is-child box">
                <p class="title">Controls</p>
                <button class="button" onclick="Settings.startAtJan=!Settings.startAtJan;loadCalendar();">Start at 1 jan</button>
              </div>

              <div class="tile is-4 is-child box" style="visibility:hidden">
              </div>

              <div class="tile is-4 is-child box">
                <p class="title" id="legend">Legend</p>

                <!-- <div style="color:blanchedalmond;font-size:40px;">&#9632;</div><p>Login to show your events.</p> -->
                <!-- <div class="tile is-ancestor is-vertical">
                  <div class="tile is-parent">
                     
                    <div class="tile is-2 is-child box" style="background-color: blanchedalmond;height:25px;width:25px;">
                    </div>
                    <div class="tile is-1 is-child box" style="visibility:hidden">
                    </div>
                    <div class="tile is-child">
                      <p>Login to show your events.</p>
                    </div>
                  </div>
                  
                </div> -->
<!-- 
                <div class="media">
                  <div class="media-left">
                      <p style="color:blanchedalmond;">&#9632;</p>
                  </div>
                  <div class="media-content">
                    <p>Login to show your events.</p>
                  </div>
                </div>

                <div class="media">
                  <div class="media-left">
                      <p style="color:blanchedalmond;">&#9632;</p>
                  </div>
                  <div class="media-content">
                    <p>Login to show your events.</p>
                  </div>
                </div> -->

                <!-- <ul>
                  <li><span class="legend-color" style="background-color: #3498db;"></span> Public Holidays</li>
                  <li><span class="legend-color" style="background-color: #2ecc71;"></span> Work Days</li>
                  <li><span class="legend-color" style="background-color: #f1c40f;"></span> Meetings</li>
                  <li><span class="legend-color" style="background-color: #e74c3c;"></span> Important Deadlines</li>
                  <li><span class="legend-color" style="background-color: #ecf0f1;"></span> No Events</li>
                </ul> -->

                <ul id="legendList">
                  <li><span class="legend_item" style="background-color: blanchedalmond;"></span> Login to show your events.</li>
                </ul>

                <!-- <br><br> -->
              </div>

            </div>
          </div>

          <div class="tile box">
            <div class="calendar" id="planning_auto">
              <script>
                function addWeek(weekNumber){
                  let week = document.createElement("div");
                  week.className = "week #:";
                  week.id="w" + weekNumber;
                  document.getElementById("planning_auto").appendChild(week);
                }
      
                function addDay(weekNumber, dayNumber, text, classname="day", color=0, isPast=false){
                  let day = document.createElement("div");
                  day.className = classname;
                  day.innerHTML=text;
                  day.id="w" + weekNumber + "d" + dayNumber;
                  day.style.color="rgba(0, 0, 0, 1);"
                  if(color!==0){
                    day.style.backgroundColor = Colors.eventById[color];
                    // console.log("painting day w" + weekNumber + "d" + dayNumber + " with color " + color + "=" + Colors.eventById[color]);

                    if(isPast){
                      day.style.backgroundColor = Colors.scaleLightness(Colors.eventById[color], 4);
                    }
                  }

                  if(color===-1) day.style.color="#999999";
                  
      
                  document.getElementById("w" + weekNumber).appendChild(day);
                }
  
                function addMonth(monthNumber, weekNumber, dayNumber, left, top){
                  const Months = {0:"January", 1:"February", 2:"March", 3:"April", 4:"May", 5:"June", 6:"July", 7:"August", 8:"September", 9:"Oktober", 10:"November", 11:"December"}
                  let month = document.createElement("div");
                  month.className = "background_text";
                  month.innerHTML = Months[monthNumber].substring(0,3);
                  month.id = "m" + monthNumber;
                  month.style.left = left + "px";
                  month.style.top = top + "px";
                  // console.log("add " + Months[monthNumber] + " at: " + left + ", " + top);
                  document.getElementById("w" + weekNumber + "d" + dayNumber).appendChild(month);
  
                }
      
                function drawCalendar(){
                  const Weekdays = {0:"Mo", 1:"Tu", 2:"We", 3:"Th", 4:"Fr", 5:"Sa", 6:"Su",}
      
                  //empty current calendar if any
                  let calendar = document.getElementById("planning_auto")
                  let content = calendar.lastElementChild;  
                  while (content) { 
                    calendar.removeChild(content); 
                    content = calendar.lastElementChild; 
                  }
      
                  let current_date = new Date();
                  let startDate = new Date(current_date.getFullYear(), 0, 1);
                  if(Settings.startAtJan===true){
                    current_date = startDate;
                  }

                  let days = Math.floor((current_date - startDate) / (24*60*60*1000));
                  let current_week = Math.ceil(days / 7);
      
                  // Calendar Header
                  addWeek(-2);
                  addDay(-2, -1, "", classname="day_hspace");//Month
                  for(let i=0;i<7;i++) addDay(-2, i, Weekdays[i], classname="day", color=-1);
                  addDay(-2, 7, "week", classname="day", color=-1);
      
                  for(let w=0; w<52; w++){
                    addWeek(w);
                    addDay(w, -1, "", classname="day_hspace");
      
                    starting_weekday = (current_date.getDay() - 1) % 7;
                    for(let d=0; d<7; d++){
                      if(w===0 && d < starting_weekday){//skip days of first week when current day not being the first of the week
                        addDay(w, d, "", classname="day_hspace");
                        continue;
                      }
  
                      let future_date = new Date(utc(current_date) + 1000*60*60*24*(w*7 + d - starting_weekday));
                      let [cat, colId] = checkForEvent(future_date);
                      let isPast=false;
                      if(utc(future_date) < utc(new Date())) isPast = true;

                      addDay(w, d, future_date.getDate(), classname="day", color=colId, isPast);
                      
                      if(d===3 && 0 < future_date.getDate() && future_date.getDate() <= 7){
                        function getBbx(id) {return document.getElementById(id).getBoundingClientRect();}
                        addMonth(future_date.getMonth(), w, -1, 0, -5);
                      }
                    }
  
                    addDay(w, 7, (w + current_week) % 52, classname="day", color=-1);//week
                  }
                }
      
                drawCalendar();
              </script>
            </div>
          </div>
        </div>
      </div>
    </section>

    <script>
      function openTab(event, tabName) {
        let tabSections = document.getElementsByClassName("tabSection");
        for (i = 0; i < tabSections.length; i++) {
          tabSections[i].style.display = "none";
        }
        document.getElementById(tabName).style.display = "block";

        let calendarControls = document.getElementsByClassName("calendar-google-ctrl");
        for (i = 0; i < calendarControls.length; i++) {
          if(tabName === "calendar"){
            calendarControls[i].style.display = "block";
            console.log("control turned on");
          } else {
            calendarControls[i].style.display = "none";
            console.log("control turned off");
          }
        }

        if(tabName==="calendar"){
          document.getElementById("title").innerHTML = "Calendar";
        } 
        if(tabName==="about"){
          document.getElementById("title").innerHTML = "Danny Rogaar";
        } 

        // // tab button display
        // tablinks = document.getElementsByClassName("tablinks");
        // for (i = 0; i < tablinks.length; i++) {
        //   tablinks[i].className = tablinks[i].className.replace(" active", "");
        // }
        // event.currentTarget.className += " active";
      }
      openTab("", "about");
    </script>

  </body>
</html>
